---
title: "Correspondence Analysis"
author: "David C. King"
date: "4/5/2022"
output: html_document
---

Various references:

The procedure and its calculation:

https://www.displayr.com/math-correspondence-analysis/

Using count data:

https://stats.stackexchange.com/questions/68938/multiple-correspondence-analysis-for-count-data-entered-as-binary-variables

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(factoextra)
library(ggplot2)
library(ade4)
library(tidyr)
library(dplyr)
library(GenomicRanges)
#install.packages("devtools")
#devtools::install_github("meekrob/ParasiteXML") # Brings biomaRt, GenomicRanges
library(ParasiteXML)
bcd=getwd()
setwd('/Users/david/work/ELT-2-ChIP-revision/David/01_promoters/02_scripts')
source('david-reader.R')
setwd(bcd)
```

```{r read-data}
setwd('/Users/david/work/ELT-2-ChIP-revision/David/01_promoters/02_scripts')
elt2.data = read_ELT2_binding_data(as_genomic_ranges = FALSE)
intestine = read_rob_all_merged() %>% dplyr::select(-starts_with("pvalue."),-starts_with("lfcSE."))
elt2.intestine = inner_join(intestine, elt2.data, by = "WBGeneID")
```

```{r query-promoters-or-read-saved}
setwd('/Users/david/work/ELT-2-ChIP-revision/David/01_promoters/02_scripts')
# Promoters
PROMOTERS_RDS_PATH = file.path("bioMart_saved_queries", "promoters.rds")

if (! file.exists(PROMOTERS_RDS_PATH)) {
  library(biomaRt)
  mart = getParamart()
  
  promoters = getCElegansPromoters(mart, upstream = UPSTREAM, downstream = DOWNSTREAM) 
  promoters = trim(sort(promoters, ignore.strand=T)) # trim because one interval is chrIV:-359-840 at -1000/+200
  
  saveRDS(promoters, PROMOTERS_RDS_PATH)
}else { 
  message("Using saved promoter query.")
  promoters = readRDS(PROMOTERS_RDS_PATH)
}

```


```{r read-all-modENCODE-binding-sites}
allBindingSites = read.table('all.modENCODE.binding.bed')
header = read.table('all.modENCODE.binding.bed', nrows = 1, comment.char = "")
header[1] <- 'chrom'
colnames(allBindingSites) <- header
allBindingSites[1:5,1:20]
gr.bindingsites = makeGRangesFromDataFrame(allBindingSites, keep.extra.columns = T)
```

```{r binding-sites-to-promoters}
olap = GenomicRanges::findOverlaps(promoters, gr.bindingsites, ignore.strand=T,minoverlap = 100)
# create blank columns 
gr.bindingsites$WBGeneID = NA
gr.bindingsites$gene_name = NA 
# fill data with match
gr.bindingsites[to(olap)]$WBGeneID = promoters[from(olap)]$wbps_gene_id
gr.bindingsites[to(olap)]$gene_name = promoters[from(olap)]$external_gene_id
gr.promoter.bindingsites = gr.bindingsites[ !is.na(gr.bindingsites$WBGeneID)]
length(gr.promoter.bindingsites)
```



```{r big-data}
promoter.bindingsites = mcols(gr.promoter.bindingsites)
bigDF = right_join(elt2.intestine, promoter.bindingsites, by = "WBGeneID",copy=T)
# NOTE: copy=T is required by:
# Error in `auto_copy()`:
# ! `x` and `y` must share the same src.
# â„¹ set `copy` = TRUE (may be slow).
# Backtrace:
#  1. dplyr::left_join(elt2.intestine, promoter.bindingsites, by = "WBGeneID")
#  2. dplyr:::left_join.data.frame(...)
#  3. dplyr::auto_copy(x, y, copy = copy)

bigDF.din = bigDF %>% filter(!is.na(din.status))
#bigDF.din[is.na(bigDF.din)] <- "ftr" # FTRs replace any not enriched/equal/depleted

```


```{r aggregation}

x = bigDF.din %>% filter(embryo_int_exp == 'enriched' & L1_int_exp == 'enriched')
x.bindingpattern = x %>% select(-i, -score, -.) %>% select(LE_bound:ZTF.7)

dups = names(which(table(x$gene_name)>1))
###
### need to do something here to collapse multiple rows for the same gene/promoter
###
nondup = x %>% filter(! gene_name %in% dups)
nondup.bindingpattern = nondup %>% select(-i, -score, -.) %>% select(LE_bound:ZTF.7)
  
rownames(nondup.bindingpattern) <- nondup$gene_name
#bigDF.din %<>% select(din.status.description, embryo_int_exp, L1_int_exp, L3_int_exp, LE_bound:ZTF.7) %>% select(-i, -score, -.)

agg1 = stats::aggregate(x %>% select(-i, -score, -.) %>% select(LE_bound:ZTF.7), 
                       by=list(dineen.status=x$din.status.description),
                       FUN=sum)
rownames(agg1) <- agg1[[1]]
agg1 = agg1[,-1]

write.table(agg1, "CA.tab", quote=F)
# compute the dot product between points and vectors

agg.ca = dudi.coa(agg1, scannf=FALSE, nf=2)
scores = as.matrix(agg.ca$co) %*% t(as.matrix(agg.ca$li))
selectedcols = rownames(scores)[abs(apply(scores, 1, max))> .014]
fviz_ca_biplot(agg.ca,repel=TRUE,
               col.col="brown", 
               col.row="purple", 
               arrows=c(T,F), 
               select.col = list(name=selectedcols),
               max.overlaps=70) +
ggtitle("Correspondance Analysis") #+ #ylim(c(-0.5,0.5)) +
  # geom_point(inherit.aes=FALSE,
  #            data=data.frame(x=c(0.06213413,0.2072243),
  #                            y=c(-0.1359036,-0.3136792)),
  #            aes(x=x,y=y))

# the highest score for up_ELT2_minus
# is shared by these four hits who bind once apiece in two up_ELT2_minus gene
agg1[,c('CEH.26','EGL.5', 'SEM.4')]
#                      CEH.26 EGL.5 SEM.4
# down_ELT2_minus           0     0     0
# unchanged_ELT2_minus      0     0     0
# up_ELT2_minus             1     1     1
x %>% filter(CEH.26| EGL.5 |SEM.4) %>% select(gene_name, 'CEH.26', 'EGL.5', 'SEM.4')


agg1[,c("CEH.39", "LIN.11", "NHR.2",  "ZTF.11")]

x %>% filter(CEH.39|LIN.11 |NHR.2  |ZTF.11) %>% select(gene_name,"CEH.39", "LIN.11", "NHR.2",  "ZTF.11")


# apply the scores back to the binding obj to find the best-described genes for "up"
n = nrow(nondup.bindingpattern)
mx = matrix(rep(c(scores[,3]),n), nrow=n, byrow=T)
dimnames(mx) <- list(rownames=rownames(nondup.bindingpattern), colnames(nondup.bindingpattern))
# apply score matrix to binding pattern
scored_targets = rowSums(nondup.bindingpattern * mx) %>% sort(decreasing=T)
top_ten = scored_targets[1:10]
binding_pattern.top_ten = nondup.bindingpattern[names(top_ten),]
zero_columns = which(colSums(nondup.bindingpattern[names(top_ten),]) == 0)
binding_pattern.top_ten = binding_pattern.top_ten[, -zero_columns]
binding_pattern.top_ten

ggsave("CO_biplot.LEL1.enrichedonly.pdf", width=15, height=20)


threshold=100
agg1.highercounts = agg1[,which(colSums(agg1)>=threshold)]
agg.ca.highercounts = dudi.coa(agg1.highercounts, scannf=FALSE, nf=2)
fviz_ca_biplot(agg.ca.highercounts,repel=TRUE,col.col="brown", col.row="purple", arrows=c(T,F)) +
    ggtitle(sprintf("Correspondance Analysis (%d or more total counts)",threshold)) + ylim(c(-0.5,0.5)) #+ xlim(c(-.3,.6))
ggsave(sprintf("CO_biplot.LEL1.enrichedonly.%d.pdf", threshold), width=15, height=20)
```

```{r look-at-resids}
n = sum(agg1)
p = agg1/n
column.masses = colSums(p)
row.masses = rowSums(p)
E = row.masses %o% column.masses
R = p - E
I = R / E
is_finite = is.finite(unlist(I[1,]))
pdf("CA_indexed_residuals.pdf", width=10, height=12)
pheatmap(t(I[,is_finite]))
dev.off()
```


```{r pheatmap}

pheatmap(t(agg1.70[,-3]))
```
